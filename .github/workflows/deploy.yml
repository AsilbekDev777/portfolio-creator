name: Nextjs CI/CD

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment"
        type: choice
        required: true
        options:
          - dev
          - staging
          - prod
        default: dev
      deploy:
        description: "Deploy after build?"
        type: boolean
        required: true
        default: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (with Next.js)
        run: |
          echo "Installing all dependencies..."
          npm ci
          # yoki agar package-lock.json bo'lmasa:
          # npm install --legacy-peer-deps
          
          # Next.js mavjudligini tekshirish
          echo "Checking Next.js installation..."
          ls node_modules/.bin/ | grep next || echo "Next.js not found in node_modules/.bin/"
          
          # Package.json'dagi dependencies ni ko'rish
          echo "Dependencies in package.json:"
          npm list next 2>/dev/null || echo "Next is not installed"

      - name: Verify Next.js installation
        run: |
          echo "Checking if next command exists..."
          # npx bilan sinab ko'rish
          npx next --version || echo "Cannot find next command"
          
          # node_modules ichidan qidirish
          if [ -f "node_modules/.bin/next" ]; then
            echo "✅ Next.js found in node_modules/.bin/next"
            ./node_modules/.bin/next --version
          else
            echo "❌ Next.js not found in node_modules"
            echo "Trying to install Next.js explicitly..."
            npm install next@latest react@latest react-dom@latest
          fi

      - name: Create environment file
        run: |
          echo "Creating .env.production..."
          # Basic environment variables
          cat > .env.production << EOF
          NODE_ENV=production
          NEXT_PUBLIC_ENV=${{ github.event.inputs.environment }}
          NEXT_TELEMETRY_DISABLED=1
          EOF

      - name: Build Next.js app
        run: |
          echo "Building Next.js application..."
          
          # Build komandasini to'g'ridan-to'g'ri ishga tushirish
          npx next build || {
            echo "Build failed with npx, trying alternative methods..."
            
            # Alternative 1: node_modules/.bin dan
            if [ -f "node_modules/.bin/next" ]; then
              ./node_modules/.bin/next build
            else
              # Alternative 2: Install and build
              echo "Installing Next.js and building..."
              npm install next@latest react@latest react-dom@latest
              npx next build
            fi
          }
          
          echo "✅ Build completed successfully!"

      - name: Run tests (if any)
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            npm test
          else
            echo "No tests configured"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: |
            .next/
            public/
            package.json
          retention-days: 5

  deploy:
    needs: build
    if: ${{ github.event.inputs.deploy == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build

      - name: Deploy
        run: |
          echo "Deploying to ${{ github.event.inputs.environment }}..."
          # O'zingizning deploy komandalaringizni qo'ying